<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reviewer Summary ‚Äì FY2025</title>
  <style>
    :root {
      --brand-primary-600: #7a1fd8;
      --brand-primary-500: #8a33de;
      --brand-primary-400: #a657e8;
      --brand-surface: #f7f3fd;
      --brand-outline: #eadcfb;
      --brand-link: #7a1fd8;
      --brand-amber: #ffb74d;
      --text-primary: #1f2937;
      --text-muted: #4b5563;
    }
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
    h1, h2 { margin-top: 0; }
    .header { border-bottom: 2px solid #ddd; padding-bottom: 12px; margin-bottom: 20px; }
    .meta { color: #555; }
    .section { border: 1px solid #e6e6e6; margin-bottom: 18px; padding: 16px; border-radius: 6px; background: #fafafa; }
    .flag { margin: 16px 0 20px; padding: 0; border-left: 5px solid #ff9800; background: #ffffff; border-radius: 10px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.08); border: 1px solid #eceff4; }
    .flag h3 { margin: 0 0 6px; }
    .carried { border-left: 5px solid #1976d2; }
    .flag.approved { border-left: 5px solid #30a46c; background: #f3fff6; }
    .flag.warning { border-left: 5px solid #ff9800; }
    .flag.snoozed { border-left: 5px solid #b0b8c4; }
    .icon { font-size: 18px; margin-right: 6px; }
    .controls { margin-top: 8px; }
    button { margin: 4px; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-approve { background: #4caf50; color: white; }
    .btn-edit { background: var(--brand-primary-600); color: white; }
    .btn-doc { background: #6b7280; color: white; }
    .btn-link { background: var(--brand-primary-500); color: white; }
    .btn-lock { background: var(--brand-primary-600); color: white; }
    details { margin-top: 6px; background: #fff; border: 1px solid #e6e6e6; border-radius: 4px; padding: 8px; }
    details summary { cursor: pointer; font-weight: bold; }
    .letter { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 6px; line-height: 1.6; }
    .issue-block { margin: 18px 0; padding: 12px; border-left: 4px solid #b0b8c4; background: #f8f9fb; border-radius: 4px; }
    .issue-block.carried { border-left: 4px solid #93a6d1; background: #f4f6fb; }
    .actions { text-align: center; margin-top: 16px; }
    /* New unified card header + status chips */
    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 12px 14px; background: linear-gradient(90deg,var(--brand-surface) 0%, #ffffff 100%); border-bottom: 1px solid var(--brand-outline); }
    .card-title { font-weight: 700; letter-spacing: 0.2px; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
    .status { padding: 4px 10px; border-radius: 999px; font-size: 12px; color: #333; background: #eef2f7; border: 1px solid #d7dde6; box-shadow: inset 0 -1px 0 rgba(0,0,0,0.02); }
    .status-draft { background: #fff; }
    .status-aml { background: #fff7ed; border-color: #f3d1a8; color: #8a5800; }
    .status-approved { background: #e7f7ea; color: #1b5e20; border-color: #c8e6c9; }
    .status-carried { background: #f1e8fb; color: #5b21b6; border-color: #e9d5ff; }
    .status-snoozed { background: #fff3cd; color: #795548; border-color: #ffe08a; }
    .flag-summary { margin: 6px 0 10px; color: #333; }
    .field-label { font-weight: bold; display: block; margin: 10px 0 6px; }
    textarea { width: 100%; min-height: 72px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
    .action-row { display: flex; flex-wrap: wrap; gap: 8px 14px; align-items: center; margin-top: 10px; }
    .toggle { display: inline-flex; align-items: center; gap: 6px; }
    .snoozed { opacity: 0.6; }
    .audit { margin-top: 8px; font-size: 12px; color: #555; }
    .audit ul { margin: 6px 0 0 18px; }
    .res-cat { margin: 8px 0; }
    .res-cat h4 { margin: 6px 0; font-size: 14px; }
    .res-cat li { margin: 4px 0; }
    .res-actions { margin-left: 8px; }
    .learn-more-block { margin-top: 8px; }
    .card-header .btn-toggle { background: #f2eafb; color: var(--text-primary); border: 1px solid var(--brand-outline); padding: 4px 8px; font-size: 12px; border-radius: 8px; cursor: pointer; transition: all .15s ease; }
    .card-header .btn-toggle:hover { background: #eadcfb; }
    .card.collapsed .card-body { display: none; }
    .card .card-body { padding: 14px; background: #ffffff; }
    .flag.card:hover { box-shadow: 0 10px 24px rgba(122,31,216,0.18); transform: translateY(-1px); transition: box-shadow .2s ease, transform .2s ease; }
    .chev { display: inline-block; transition: transform .15s ease; font-size: 14px; line-height: 1; }
    .card.collapsed .card-header .chev { transform: rotate(-90deg); }
    .hidden { display: none; }
    /* Dashboard styles */
    .dash-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .subtabs { display: flex; gap: 10px; margin: 8px 0 16px; }
    .subtab { padding: 6px 12px; border-radius: 999px; border: 1px solid var(--brand-outline); background: #fff; cursor: pointer; font-size: 13px; }
    .subtab.active { background: var(--brand-surface); color: var(--brand-primary-600); border-color: var(--brand-primary-400); }
    .filters { display: grid; grid-template-columns: 1fr repeat(6, minmax(120px, auto)); gap: 10px; align-items: center; margin: 8px 0 14px; }
    .filters .search { grid-column: 1 / span 1; }
    .filters input[type="text"], .filters select { width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; }
    .stats { display: flex; gap: 24px; margin: 12px 0 18px; }
    .stat { display: flex; gap: 8px; align-items: baseline; color: #374151; }
    .stat strong { font-size: 20px; }
    .table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.05); }
    .table th, .table td { padding: 12px 14px; border-bottom: 1px solid #edf1f7; text-align: left; }
    .table th { background: #fafbff; color: #374151; font-weight: 600; font-size: 14px; }
    .table tr:hover { background: #faf6ff; }
    .btn-mini { padding: 6px 10px; border-radius: 8px; font-size: 12px; background: var(--brand-primary-500); color: #fff; border: 1px solid var(--brand-outline); cursor: pointer; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; background: #eef2f7; color: #374151; border: 1px solid #d7dde6; }
    .icon-btn { background: transparent; border: 1px solid #e5e7eb; border-radius: 8px; padding: 6px; cursor: pointer; }
    .icon-btn:hover { background: var(--brand-surface); border-color: var(--brand-outline); }
    .icon { width: 16px; height: 16px; display: inline-block; vertical-align: middle; }
    /* Return viewer (interactive) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-card { background: #fff; width: 900px; max-width: 95vw; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,.25); overflow: hidden; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #edf1f7; }
    .modal-title { font-weight: 700; }
    .modal-actions { display: flex; gap: 8px; }
    .modal-body { padding: 16px; max-height: 70vh; overflow: auto; }
    .viewer-grid { display: grid; grid-template-columns: 1fr 200px; gap: 10px 16px; align-items: center; }
    .viewer-grid label { color: #374151; }
    .viewer-grid input, .viewer-grid select { width: 100%; padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; }
    .img-modal-body img { max-width: 100%; height: auto; display: block; margin: 0 auto; border: 1px solid #edf1f7; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,.1); }
    /* Estimate card */
    .estimate { background:#fff;border:1px solid #edf1f7;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06); padding: 12px 14px; }
    .estimate-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    /* Estimate summary */
    .estimate-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px; }
    @media (max-width: 800px) { .estimate-summary { grid-template-columns: 1fr; } }
    .kv-list { list-style: none; margin: 0; padding: 0; border: 1px solid #edf1f7; border-radius: 8px; background: #fff; }
    .kv-list li { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 10px; border-bottom: 1px solid #f2f4f8; }
    .kv-list li:last-child { border-bottom: 0; }
    .amount-link { color: var(--brand-primary-600); text-decoration: underline; cursor: pointer; white-space: nowrap; }
    .amount-link[aria-disabled="true"] { cursor: default; opacity: .9; }
    .estimate-note { font-size: 12px; color: #6b7280; margin-top: 6px; }
    /* What-if toggles (design only) */
    .whatif { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    @media (max-width: 800px) { .whatif { grid-template-columns: 1fr; } }
    .whatif .toggle { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px dashed #e6e6f0; border-radius: 8px; background: #fafaff; }
    .whatif-note { font-size: 12px; color: #6b7280; margin-top: 6px; }
    .estimate-body img { width:100%; height:auto; border-radius:8px; border:1px solid #edf1f7; }
  </style>
</head>
<body>
  <div class="container">
    <!-- DASHBOARD VIEW -->
    <div id="dashboard-view" class="section">
      <div class="dash-header">
        <h2>Compliance ‚Äì Returns in review</h2>
        <span class="pill">3 in review</span>
      </div>
      <div class="subtabs">
        <button class="subtab">Activity Statements</button>
        <button class="subtab active">Tax returns</button>
      </div>
      <div class="filters">
        <div class="search"><input type="text" placeholder="Client name or code"></div>
        <select><option>Tax year</option></select>
        <select><option>Type</option></select>
        <select><option>Office</option></select>
        <select><option>Partner</option></select>
        <select><option>Manager</option></select>
        <select><option>Staff member</option></select>
        <select><option>Family group</option></select>
      </div>
      <div class="stats">
        <div class="stat"><strong>879</strong> <span>All unlodged</span></div>
        <div class="stat"><strong>96</strong> <span>Not started</span></div>
        <div class="stat"><strong>767</strong> <span>In progress</span></div>
        <div class="stat"><strong>3</strong> <span>In review</span></div>
        <div class="stat"><strong>7</strong> <span>Ready for client</span></div>
        <div class="stat"><strong>1</strong> <span>Ready to lodge</span></div>
        <div class="stat"><strong>0</strong> <span>Rejected</span></div>
        <div class="stat"><strong>79</strong> <span>Lodged</span></div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Client name</th>
            <th>Period</th>
            <th>Type</th>
            <th>Next</th>
            <th>Review</th>
            <th>Lodgement due</th>
            <th>Status</th>
            <th>Status date</th>
          </tr>
        </thead>
        <tbody id="returns-tbody"></tbody>
      </table>
    </div>

    <!-- REVIEW VIEW -->
    <div id="review-view" class="hidden">
    <!-- HEADER -->
    <div class="header">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <h1>Reviewer Summary ‚Äì FY2025</h1>
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="status status-aml" title="Future: AML/CTF checks ‚Äì click to review (inactive)">AML: CDD due</span>
            <a class="btn-mini" id="pdf-link" href="#" target="_blank" rel="noopener">View full return (PDF)</a>
            <button class="btn-mini" id="btn-back-dashboard" type="button">‚Üê Back to dashboard</button>
          </div>
        </div>
        <div class="meta" id="meta-line">
          <strong>Client:</strong> <span id="client-name">John Smith</span> &nbsp;|&nbsp;
        <strong>Preparer:</strong> A. Brown &nbsp;|&nbsp;
        <strong>Reviewer:</strong> T. Lee &nbsp;|&nbsp;
        <strong>Status:</strong> Draft &nbsp;|&nbsp;
        <strong>Checklist:</strong> 9/11 complete
      </div>
        <div class="card collapsed" id="estimate-full" style="margin-top:12px;">
          <div class="card-header">
            <div class="card-title"><span class="icon">üìÑ</span>Tax Estimate 2025</div>
            <div>
              <button class="btn-toggle" id="toggle-estimate" type="button" aria-expanded="false" title="Expand"><span class="chev" aria-hidden>‚ñæ</span></button>
              <button class="btn-mini" id="open-estimate-modal" type="button">Open larger</button>
            </div>
          </div>
          <div class="card-body estimate-body">
            <div class="estimate-summary">
              <div>
                <h4>Summary of taxable income</h4>
                <ul class="kv-list" id="estimate-income-list">
                  <li><span>Salary and wages</span> <span><a class="amount-link" aria-disabled="true" role="link" tabindex="-1" title="Go to Item 1 ‚Äì Salary and wages">$95,000</a></span></li>
                  <li><span>Interest income</span> <span><a class="amount-link" aria-disabled="true" role="link" tabindex="-1" title="Go to Item 10 ‚Äì Interest">$420</a></span></li>
                  <li><span>Trust distributions</span> <span><a class="amount-link" aria-disabled="true" role="link" tabindex="-1" title="Go to Item 13 ‚Äì Partnerships and trusts">$7,500</a></span></li>
                  <li><span>Business income</span> <span><a class="amount-link" aria-disabled="true" role="link" tabindex="-1" title="Go to Item P9 ‚Äì Business income (non‚Äëprimary production)">$18,900</a></span></li>
                </ul>
                <div class="whatif">
                  <label class="toggle"><input type="checkbox" disabled checked> Apply small business offset (design)</label>
                  <label class="toggle"><input type="checkbox" disabled> Assume PAYG instalments next year (design)</label>
                </div>
              </div>
              <div>
                <h4>Carried forward items</h4>
                <ul class="kv-list" id="estimate-cf-list">
                  <li><span>Capital losses carried forward</span> <span><a class="amount-link" id="cf-capital-losses" aria-disabled="true" role="link" tabindex="-1" title="Go to Item 18 ‚Äì Capital gains">$42,000</a></span></li>
                  <li><span>Non‚Äëcommercial losses</span> <span><a class="amount-link" aria-disabled="true" role="link" tabindex="-1" title="Go to Non‚Äëcommercial losses schedule">$0</a></span></li>
                </ul>
              </div>
            </div>
            <p class="estimate-note">Amounts are illustrative and not interactive in this prototype.</p>
            <img src="assets/docs/tax_estimate_2025.png" alt="Tax estimate"/>
          </div>
        </div>
    </div>

    <!-- SECTION 1: KEY ISSUES (Unified Cards) -->
    <div class="section hidden" id="section-cards">
      <h2>Review Checklist</h2>

      <!-- Card: CGT Disposal Carried Forward -->
      <div class="flag card carried collapsed" data-key="cgt-cf">
        <div class="card-header">
          <div class="card-title"><span class="icon">‚ö†Ô∏è</span>CGT Disposal Carried Forward</div>
          <div>
            <button class="btn-toggle" type="button" data-action="toggle"><span class="chev" aria-hidden>‚ñæ</span></button>
            <span class="status status-carried" data-status>Carried forward</span>
          </div>
        </div>
        <div class="card-body">
        <p class="flag-summary">Contract date July 2025 ‚Üí outside FY2025. Excluded and carried forward.</p>
        <p><strong>‚úÖ</strong> Attach docs ‚Üí auto carry to FY2026.</p>

        <label class="field-label" for="cgtcf-note">AI draft ‚Äì Reviewer note</label>
        <textarea id="cgtcf-note" class="reviewer-note">CGT disposal contract July 2025 ‚Üí falls in FY2026. Event auto-carried forward.</textarea>

        <label class="field-label" for="cgtcf-client">AI draft ‚Äì Client copy</label>
        <textarea id="cgtcf-client" class="client-copy">Your CGT disposal contract occurred in July 2025, so the event falls into FY2026. It is excluded from this year and will be carried forward.</textarea>

        <details>
          <summary>Suggested resources</summary>
          <div class="res-cat">
            <h4>ATO guidance</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="ATO: CGT events ‚Äì contract vs settlement" data-url="https://www.ato.gov.au/individuals-and-families/investments-and-assets/capital-gains-tax/when-a-cgt-event-occurs"> ATO: CGT events ‚Äì contract vs settlement</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button> <button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Legislation / rulings</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="ITAA 1997 s104-10 ‚Äì CGT event A1" data-url="https://www.legislation.gov.au/Series/C2004A05217"> ITAA 1997 s104-10 ‚Äì CGT event A1</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button> <button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Practice resources</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="Internal: CGT timing explainer" data-url="https://intranet.myob/resources/tax/CGT_timing_explainer.pdf"> Internal: CGT timing explainer (PDF)</label>
                <span class="res-actions"><button class="btn-link" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Benchmarking</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="Peer percentile: CGT deferral common in 60th percentile" data-url="https://intranet.myob/benchmarks/cgt-deferral"> Peer percentile: CGT deferral common in 60th percentile</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button></span>
              </li>
            </ul>
          </div>
          <div class="learn-more-block" hidden>
            <strong>Learn more links added:</strong>
            <ul class="learn-links"></ul>
          </div>
        </details>

        <details>
          <summary>Documents</summary>
          <ul>
            <li>Contract.pdf</li>
            <li>Settlement.pdf</li>
          </ul>
          <button class="btn-doc" type="button">Attach / Link Document</button>
        </details>

        <details>
          <summary>Tax return</summary>
          <div>
            <button class="btn-link" type="button">Open Tax return</button>
            <button class="btn-link" type="button">Open Item 18 ‚Äì Capital gains</button>
            <button class="btn-link" type="button">Open Capital gains schedule</button>
            <button class="btn-link" type="button">Open Capital gains worksheet</button>
          </div>
        </details>

        <div class="action-row">
          <button class="btn-approve" type="button" data-action="approve">Approve</button>
          <label class="toggle"><input type="checkbox" data-action="add-to-letter"> Add to client letter</label>
          <label class="toggle"><input type="checkbox" data-action="carry-forward" checked> Carry forward to FY2026</label>
          <button class="btn-edit" type="button" data-action="snooze">Snooze / Not applicable</button>
          <button class="btn-edit" type="button" data-action="comment">Add comment</button>
          <button class="btn-edit" type="button" data-action="undo">Undo changes</button>
        </div>
        <div class="audit" hidden>
          <strong>Audit trail</strong>
          <ul></ul>
        </div>
        </div>
      </div>

      <!-- Card: PAYG Instalments Trigger -->
      <div class="flag card collapsed" data-key="payg">
        <div class="card-header">
          <div class="card-title"><span class="icon">‚ö†Ô∏è</span>PAYG Instalments Trigger</div>
          <div>
            <button class="btn-toggle" type="button" data-action="toggle"><span class="chev" aria-hidden>‚ñæ</span></button>
            <span class="status status-draft" data-status>Draft</span>
          </div>
        </div>
        <div class="card-body">
        <p class="flag-summary">New sole trader business income has no withholding. Likely PAYG for FY2026.</p>
        <p><strong>‚úÖ</strong> Consider cashflow advisory and Small business income tax offset.</p>

        <label class="field-label" for="payg-note">AI draft ‚Äì Reviewer note</label>
        <textarea id="payg-note" class="reviewer-note">Sole trader income has no withholding ‚Üí PAYG instalments expected for FY2026. Link to tax payable once return finalised. Confirm eligibility for small business income tax offset.</textarea>

        <label class="field-label" for="payg-client">AI draft ‚Äì Client copy</label>
        <textarea id="payg-client" class="client-copy">You have new sole trader business income without tax withheld, so you may begin PAYG instalments in FY2026. Once the return is completed, we will confirm your tax payable and likely PAYG amounts. You may also be eligible for the small business income tax offset. We can help plan for cashflow.</textarea>

        <details>
          <summary>Suggested resources</summary>
          <div class="res-cat">
            <h4>ATO guidance</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="ATO: PAYG instalments" data-url="https://www.ato.gov.au/business/payg-instalments/"> ATO: PAYG instalments</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button> <button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
              <li>
                <label><input type="checkbox" class="res-choice" value="ATO: Small business income tax offset" data-url="https://www.ato.gov.au/businesses-and-organisations/small-business-entity-concessions/income-tax/small-business-income-tax-offset"> ATO: Small business income tax offset</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Practice resources</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="Internal: Cashflow advisory checklist" data-url="https://intranet.myob/resources/advisory/Cashflow_Advisory_Checklist.pdf"> Internal: Cashflow advisory checklist</label>
                <span class="res-actions"><button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Benchmarking</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="PAYG prevalence among sole traders in bracket" data-url="https://intranet.myob/benchmarks/payg-prevalence"> PAYG prevalence among sole traders in bracket</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button></span>
              </li>
            </ul>
          </div>
          <div class="learn-more-block" hidden>
            <strong>Learn more links added:</strong>
            <ul class="learn-links"></ul>
          </div>
        </details>

        <details>
          <summary>Documents</summary>
          <ul>
            <li>PAYG_Estimator.pdf</li>
          </ul>
          <button class="btn-doc" type="button">Attach / Link Document</button>
        </details>

        <details>
          <summary>Tax return</summary>
          <div>
            <button class="btn-link" type="button">Open Tax return</button>
            <button class="btn-link" type="button">Open Item P9 ‚Äì Business income (non‚Äëprimary production)</button>
            <button class="btn-link" type="button">Open Item 15 ‚Äì Small business income tax offset</button>
          </div>
        </details>

        <div class="action-row">
          <button class="btn-approve" type="button" data-action="approve">Approve</button>
          <label class="toggle"><input type="checkbox" data-action="add-to-letter"> Add to client letter</label>
          <label class="toggle"><input type="checkbox" data-action="carry-forward"> Carry forward to FY2026</label>
          <button class="btn-edit" type="button" data-action="snooze">Snooze / Not applicable</button>
          <button class="btn-edit" type="button" data-action="comment">Add comment</button>
          <button class="btn-edit" type="button" data-action="undo">Undo changes</button>
        </div>
        <div class="audit" hidden>
          <strong>Audit trail</strong>
          <ul></ul>
        </div>
        </div>
      </div>

      <!-- Card: Trust Distribution - Variance -->
      <div class="flag card collapsed" data-key="trust">
        <div class="card-header">
          <div class="card-title"><span class="icon">‚ö†Ô∏è</span>Trust Distribution - Variance</div>
          <div>
            <button class="btn-toggle" type="button" data-action="toggle"><span class="chev" aria-hidden>‚ñæ</span></button>
            <span class="status status-draft" data-status>Draft</span>
          </div>
        </div>
        <div class="card-body">
        <p class="flag-summary">Distribution in Kerry's return differs from David's Family Trust ledger.</p>
        <p><strong>‚úÖ</strong> Reviewer follow-up: confirm beneficiary share and reconcile with trust accounts.</p>

        <label class="field-label" for="trust-note">AI draft ‚Äì Reviewer note</label>
        <textarea id="trust-note" class="reviewer-note">Variance detected between Kerry's return and David's Family Trust distribution ledger. Confirm allocation and reconcile to trust accounts; amend return or request ledger correction as required.</textarea>

        <!-- Reviewer-only: no client copy required -->

        <details>
          <summary>Suggested resources</summary>
          <div class="res-cat">
            <h4>ATO guidance</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="ATO: Trust distributions" data-url="https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/income-you-must-declare/trust-distributions"> ATO: Trust distributions</label>
                <span class="res-actions"><button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Legislation / rulings</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="PS LA ‚Äì Trust streaming" data-url="https://www.ato.gov.au/law/"> PS LA ‚Äì Trust streaming</label>
                <span class="res-actions"><button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="learn-more-block" hidden>
            <strong>Learn more links added:</strong>
            <ul class="learn-links"></ul>
          </div>
        </details>

        <details>
          <summary>Documents</summary>
          <ul>
            <li>David's Family Trust ‚Äì Distribution Statement 2025.pdf</li>
          </ul>
          <button class="btn-doc" type="button">Attach / Link Document</button>
        </details>

        <details>
          <summary>Tax return</summary>
          <div>
            <button class="btn-link" type="button">Open Tax return</button>
            <button class="btn-link" type="button">Open Item 13 ‚Äì Partnerships and trusts (Distributions received)</button>
            <button class="btn-link" type="button">Open Client Accounting ‚Äì Trust Beneficiary Distribution</button>
          </div>
        </details>

        <div class="action-row">
          <button class="btn-approve" type="button" data-action="approve">Approve</button>
          <!-- Reviewer-only: no client letter toggle -->
          <label class="toggle"><input type="checkbox" data-action="carry-forward"> Carry forward to FY2026</label>
          <button class="btn-edit" type="button" data-action="snooze">Snooze / Not applicable</button>
          <button class="btn-edit" type="button" data-action="comment">Add comment</button>
          <button class="btn-edit" type="button" data-action="undo">Undo changes</button>
        </div>
        <div class="audit" hidden>
          <strong>Audit trail</strong>
          <ul></ul>
        </div>
      </div>
    </div>

      <!-- Card: Rental Property Debt Risk removed per request -->

      <!-- Card: Capital losses carried forward -->
      <div class="flag card collapsed" data-key="cap-losses">
        <div class="card-header">
          <div class="card-title"><span class="icon">‚ö†Ô∏è</span>Capital losses carried forward</div>
          <div>
            <button class="btn-toggle" type="button" data-action="toggle"><span class="chev" aria-hidden>‚ñæ</span></button>
            <span class="status status-draft" data-status>Draft</span>
          </div>
        </div>
        <div class="card-body">
        <p class="flag-summary">$42,000 carried forward. Ensure correct application this year.</p>
        <p><strong>‚úÖ</strong> Flag planning for future disposals.</p>

        <label class="field-label" for="caploss-note">AI draft ‚Äì Reviewer note</label>
        <textarea id="caploss-note" class="reviewer-note">$42k capital losses carried forward. Check utilisation + planning.</textarea>

        <label class="field-label" for="caploss-client">AI draft ‚Äì Client copy</label>
        <textarea id="caploss-client" class="client-copy">You have $42,000 of capital losses carried forward. We will ensure correct application this year and use this as a planning opportunity to time future disposals tax‚Äëeffectively.</textarea>

        <details>
          <summary>Suggested resources</summary>
          <div class="res-cat">
            <h4>ATO guidance</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="ATO: Capital losses" data-url="https://www.ato.gov.au/individuals-and-families/investments-and-assets/capital-gains-tax/capital-losses"> ATO: Capital losses</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button> <button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Practice resources</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="Internal: CGT planning notes" data-url="https://intranet.myob/resources/tax/CGT_planning_notes.pdf"> Internal: CGT planning notes</label>
                <span class="res-actions"><button class="btn-doc" type="button" data-attach>Attach to item</button></span>
              </li>
            </ul>
          </div>
          <div class="res-cat">
            <h4>Benchmarking</h4>
            <ul>
              <li>
                <label><input type="checkbox" class="res-choice" value="Loss utilisation patterns vs peers" data-url="https://intranet.myob/benchmarks/capital-loss-utilisation"> Loss utilisation patterns vs peers</label>
                <span class="res-actions"><button class="btn-link" type="button" data-insert="learn-more">Insert into client copy</button></span>
              </li>
            </ul>
          </div>
          <div class="learn-more-block" hidden>
            <strong>Learn more links added:</strong>
            <ul class="learn-links"></ul>
          </div>
        </details>

        <details>
          <summary>Documents</summary>
          <ul>
            <li>Capital_Losses_Schedule.pdf</li>
          </ul>
          <button class="btn-doc" type="button">Attach / Link Document</button>
        </details>

        <details>
          <summary>Tax return</summary>
          <div>
            <button class="btn-link" type="button" data-open="tax-return">Open Tax return</button>
            <button class="btn-link" type="button" data-open="item18">Open Item 18 ‚Äì Capital gains</button>
            <button class="btn-link" type="button" data-open-schedule="capital-losses">Open Capital gains losses</button>
            <button class="btn-link" type="button" data-open-schedule="capital-gains-worksheet">Open Capital gains worksheet</button>
            <button class="btn-link" type="button" data-open-schedule-list>Related schedules and worksheets‚Ä¶</button>
          </div>
        </details>

        <div class="action-row">
          <button class="btn-approve" type="button" data-action="approve">Approve</button>
          <label class="toggle"><input type="checkbox" data-action="add-to-letter"> Add to client letter</label>
          <label class="toggle"><input type="checkbox" data-action="carry-forward"> Carry forward to FY2026</label>
          <button class="btn-edit" type="button" data-action="snooze">Snooze / Not applicable</button>
          <button class="btn-edit" type="button" data-action="comment">Add comment</button>
          <button class="btn-edit" type="button" data-action="undo">Undo changes</button>
        </div>
        <div class="audit" hidden>
          <strong>Audit trail</strong>
          <ul></ul>
        </div>
        </div>
      </div>

      <!-- Card: AirBnb income risk removed per request -->
    </div>

    <!-- SECTION 2 removed: merged into Section 1 cards -->

    <!-- SECTION 3: CLIENT COMMUNICATION -->
    <div class="section hidden collapsible collapsed" id="client-comm-section">
      <div class="section-header" style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <h2>Client Communication Draft</h2>
        <button class="btn-toggle" id="toggle-letter" type="button" aria-expanded="false" title="Expand"><span class="chev" aria-hidden>‚ñæ</span></button>
      </div>
      <div class="section-body">
      <div class="letter">
        <p>Dear Kerry,</p>

        <p>We thank you for allowing us the opportunity to assist you with your taxation needs. 
        We are pleased to enclose your Income Tax Return for the year ended 30 June 2025.</p>

        <p>Please review the Income Tax Return marked ‚ÄòClient Copy‚Äô attached to this letter. 
        Please note that the income tax calculation is an estimate only, as PAYG Instalments 
        and other disclosures in the return are dependent on the Australian Taxation Office (ATO) 
        cross-referencing these amounts.</p>

        <!-- Dynamic flagged items selected from Section 1 cards will render here -->
        <div id="letter-issues"></div>

        <!-- Continue cover letter -->
        <p>Once you are satisfied that the Income Tax Return is correct, please sign and date Parts A 
        and B of the attached Electronic Lodgement Declaration, as well as sign and date the 
        Taxpayer‚Äôs Declaration.</p>

        <p>Upon signing these Declarations, please send them to us so we can lodge your return 
        electronically with the ATO. You should receive your Notice of Assessment within 
        14 days of lodgement of the return. Please note that we have redacted your Tax File Number 
        and bank account details to protect your identity for confidentiality reasons.</p>

        <p>The Taxpayer‚Äôs Declaration that you are signing confirms that the information you have 
        provided us for the preparation of your income tax return is true and correct and that you 
        are authorising us as your registered tax agent to lodge the return on your behalf.</p>

        <p>Please note that you must also retain all records relating to the compilation of the 
        income tax return for five years (in most instances) after the Notice of Assessment 
        is issued. This will include receipts for expenses, logbooks, and other records. If you 
        do not have these records, or have any questions about the necessary records, 
        please contact us.</p>

        <p>We estimate that upon assessment you will be [required to pay income tax OR receive an 
        income tax refund] of $xxx.xx. This amount has been calculated based on a taxable income 
        of $xx,xxx.xx.<br>
        [IF RELEVANT] Your Reportable Fringe Benefits figure for the year was $xx,xxx.xx.<br>
        [IF RELEVANT] The amount of Higher Education Loan Program (HELP) repaid was $xx,xxx.xx.</p>

        <p>We also enclose our account for the preparation and lodgement of your Income Tax Return.</p>

        <p>Finally, we thank you for your support and the opportunity to be of service to you.
        If you have further queries on any details contained in this letter or on any other matter, 
        please feel free to contact us on [insert telephone number].</p>

        <p>Yours faithfully,<br>[Insert Name and Title]</p>
      </div>
      </div>
    </div>

    <!-- SECTION 4: ACTIONS -->
    <div class="section actions hidden" id="actions-section">
      <button class="btn-approve">Approve All Items</button>
      <button class="btn-edit">Edit Client Letter</button>
      <button class="btn-lock">Lock & Publish</button>
    </div>
  <script>
    (function() {
      function nowIso() {
        try { return new Date().toISOString(); } catch(e) { return '' }
      }

      function setStatus(card, status) {
        const chip = card.querySelector('[data-status]');
        if (!chip) return;
        chip.classList.remove('status-draft','status-approved','status-carried','status-snoozed');
        // Reset card state classes
        card.classList.remove('approved','warning');
        // icon element in title
        const titleIcon = card.querySelector('.card-title .icon');
        if (status === 'approved') {
          chip.textContent = 'Approved';
          chip.classList.add('status-approved');
          card.classList.remove('snoozed');
          card.classList.add('approved');
          if (titleIcon) titleIcon.textContent = '‚úÖ';
        } else if (status === 'carried') {
          chip.textContent = 'Carried forward';
          chip.classList.add('status-carried');
          card.classList.remove('snoozed');
          card.classList.add('carried');
          if (titleIcon) titleIcon.textContent = 'üìÇ';
        } else if (status === 'snoozed') {
          chip.textContent = 'Snoozed';
          chip.classList.add('status-snoozed');
          card.classList.add('snoozed');
          if (titleIcon) titleIcon.textContent = '‚è∏Ô∏è';
        } else {
          chip.textContent = 'Draft';
          chip.classList.add('status-draft');
          card.classList.remove('snoozed');
          card.classList.add('warning');
          if (titleIcon) titleIcon.textContent = '‚ö†Ô∏è';
        }
        chip.setAttribute('data-status-value', status);
      }

      function upsertLetterBlock(key, title, icon, text, carried) {
        const container = document.getElementById('letter-issues');
        if (!container) return;
        let block = container.querySelector('[data-letter-key="'+key+'"]');
        if (!text || text.trim() === '') {
          if (block) block.remove();
          return;
        }
        if (!block) {
          block = document.createElement('div');
          block.className = 'issue-block'+(carried ? ' carried' : '');
          block.setAttribute('data-letter-key', key);
          block.innerHTML = '<h3><span class="icon">'+icon+'</span>'+title+'</h3><p class="copy"></p><ul class="notes"></ul>';
          container.appendChild(block);
        } else {
          block.className = 'issue-block'+(carried ? ' carried' : '');
          const h3 = block.querySelector('h3');
          if (h3) h3.innerHTML = '<span class="icon">'+icon+'</span>'+title;
        }
        const p = block.querySelector('.copy');
        if (p) p.textContent = text;
      }

      function addNoteToLetter(key, note) {
        const container = document.getElementById('letter-issues');
        if (!container) return;
        const block = container.querySelector('[data-letter-key="'+key+'"]');
        if (!block) return;
        const ul = block.querySelector('.notes');
        if (!ul) return;
        const li = document.createElement('li');
        li.textContent = note;
        ul.appendChild(li);
      }

      // --- Undo support per card ---
      function snapshotState(card) {
        const payload = {
          status: card.querySelector('[data-status]')?.getAttribute('data-status-value') || 'draft',
          reviewerNote: card.querySelector('.reviewer-note')?.value || '',
          clientCopy: card.querySelector('.client-copy')?.value || '',
          addToLetter: !!card.querySelector('[data-action="add-to-letter"]')?.checked,
          carryForward: !!card.querySelector('[data-action="carry-forward"]')?.checked,
          auditHtml: card.querySelector('.audit ul')?.innerHTML || '',
          learnHtml: card.querySelector('.learn-links')?.innerHTML || ''
        };
        card._history = card._history || [];
        card._history.push(payload);
        if (card._history.length > 10) card._history.shift();
      }

      function undoLastChange(card) {
        const hist = card._history || [];
        if (!hist.length) return;
        const prev = hist.pop();
        const reviewer = card.querySelector('.reviewer-note');
        if (reviewer) reviewer.value = prev.reviewerNote;
        const client = card.querySelector('.client-copy');
        if (client) {
          client.value = prev.clientCopy;
          client.dispatchEvent(new Event('input'));
        }
        const addTo = card.querySelector('[data-action="add-to-letter"]');
        if (addTo) {
          addTo.checked = prev.addToLetter;
          addTo.dispatchEvent(new Event('change'));
        }
        const cf = card.querySelector('[data-action="carry-forward"]');
        if (cf) {
          cf.checked = prev.carryForward;
          cf.dispatchEvent(new Event('change'));
        }
        setStatus(card, prev.status);
        const auditUl = card.querySelector('.audit ul');
        if (auditUl) {
          card.querySelector('.audit').hidden = !prev.auditHtml;
          auditUl.innerHTML = prev.auditHtml;
        }
        const learnUl = card.querySelector('.learn-links');
        if (learnUl) {
          const block = card.querySelector('.learn-more-block');
          if (block) block.hidden = !prev.learnHtml;
          learnUl.innerHTML = prev.learnHtml;
        }
      }

      function handleResourceActions(card) {
        const clientCopy = card.querySelector('.client-copy');
        const learnBlock = card.querySelector('.learn-more-block');
        const learnList = card.querySelector('.learn-links');
        function ensureLearnVisible() {
          if (learnBlock) learnBlock.hidden = false;
        }
        card.querySelectorAll('[data-insert="learn-more"]').forEach(function(btn){
          btn.addEventListener('click', function(e){
            snapshotState(card);
            const label = e.target.closest('li')?.querySelector('label');
            const url = label?.querySelector('input')?.getAttribute('data-url') || '#';
            const text = label?.innerText?.trim() || 'Resource';
            // Append a Learn more link in the client copy
            if (clientCopy) {
              const existing = clientCopy.value.trim();
              const linkText = ` Learn more: ${text} (${url})`;
              clientCopy.value = existing ? existing + '\n' + linkText : linkText;
              clientCopy.dispatchEvent(new Event('input'));
            }
            // Track in card Learn more list
            if (learnList) {
              ensureLearnVisible();
              const li = document.createElement('li');
              li.textContent = `${text}`;
              learnList.appendChild(li);
            }
          });
        });

        card.querySelectorAll('[data-attach]').forEach(function(btn){
          btn.addEventListener('click', function(e){
            snapshotState(card);
            const label = e.target.closest('li')?.querySelector('label');
            const text = label?.innerText?.trim() || 'Attachment';
            const audit = card.querySelector('.audit');
            if (audit) {
              audit.hidden = false;
              const ul = audit.querySelector('ul');
              const li = document.createElement('li');
              li.textContent = nowIso()+': Attached resource - '+text;
              ul.appendChild(li);
            }
          });
        });
      }

      function removeLetterBlock(key) {
        const container = document.getElementById('letter-issues');
        const block = container && container.querySelector('[data-letter-key="'+key+'"]');
        if (block) block.remove();
      }

      function initCard(card) {
        const key = card.getAttribute('data-key');
        const title = card.querySelector('.card-title')?.textContent?.trim() || '';
        const icon = card.querySelector('.card-title .icon')?.textContent || '';
        const clientCopy = card.querySelector('.client-copy');

        // Initial carried status
        const carriedChecked = card.querySelector('[data-action="carry-forward"]')?.checked;
        if (carriedChecked) setStatus(card, 'carried');

        const approveBtn = card.querySelector('[data-action="approve"]');
        if (approveBtn) approveBtn.addEventListener('click', function() {
          snapshotState(card);
          setStatus(card, 'approved');
          const audit = card.querySelector('.audit');
          if (audit) {
            audit.hidden = false;
            const ul = audit.querySelector('ul');
            const li = document.createElement('li');
            li.textContent = nowIso()+': Approved by reviewer';
            ul.appendChild(li);
          }
        });

        const carryTgl = card.querySelector('[data-action="carry-forward"]');
        if (carryTgl) carryTgl.addEventListener('change', function() {
          snapshotState(card);
          setStatus(card, this.checked ? 'carried' : 'draft');
          const addToLetter = card.querySelector('[data-action="add-to-letter"]');
          if (addToLetter && addToLetter.checked) {
            upsertLetterBlock(key, title, icon, clientCopy?.value || '', this.checked);
          }
        });

        const snoozeBtn = card.querySelector('[data-action="snooze"]');
        if (snoozeBtn) snoozeBtn.addEventListener('click', function() {
          snapshotState(card);
          const chipVal = card.querySelector('[data-status]')?.getAttribute('data-status-value');
          const newState = chipVal === 'snoozed' ? 'draft' : 'snoozed';
          setStatus(card, newState);
          const audit = card.querySelector('.audit');
          if (audit) {
            audit.hidden = false;
            const ul = audit.querySelector('ul');
            const li = document.createElement('li');
            li.textContent = nowIso()+': '+(newState==='snoozed'?'Snoozed/Not applicable':'Unsnoozed');
            ul.appendChild(li);
          }
        });

        const commentBtn = card.querySelector('[data-action="comment"]');
        if (commentBtn) commentBtn.addEventListener('click', function() {
          snapshotState(card);
          const note = prompt('Add comment (appears in audit trail; added to client letter if included):');
          if (!note) return;
          const audit = card.querySelector('.audit');
          if (audit) {
            audit.hidden = false;
            const ul = audit.querySelector('ul');
            const li = document.createElement('li');
            li.textContent = nowIso()+': '+note;
            ul.appendChild(li);
          }
          const addToLetterChecked = card.querySelector('[data-action="add-to-letter"]')?.checked;
          if (addToLetterChecked) {
            // Ensure block exists and append note
            upsertLetterBlock(key, title, icon, clientCopy?.value || '', card.querySelector('[data-action="carry-forward"]')?.checked);
            addNoteToLetter(key, note);
          }
        });

        const addToLetter = card.querySelector('[data-action="add-to-letter"]');
        if (addToLetter) addToLetter.addEventListener('change', function() {
          snapshotState(card);
          if (this.checked) {
            upsertLetterBlock(key, title, icon, clientCopy?.value || '', card.querySelector('[data-action="carry-forward"]')?.checked);
          } else {
            removeLetterBlock(key);
          }
        });

        if (clientCopy) clientCopy.addEventListener('input', function() {
          snapshotState(card);
          const checked = card.querySelector('[data-action="add-to-letter"]')?.checked;
          if (checked) {
            upsertLetterBlock(key, title, icon, clientCopy.value, card.querySelector('[data-action="carry-forward"]')?.checked);
          }
        });

        // Wire up resource actions within this card
        handleResourceActions(card);

        // Toggle collapse
        const toggleBtn = card.querySelector('[data-action="toggle"]');
        if (toggleBtn) toggleBtn.addEventListener('click', function(){
          card.classList.toggle('collapsed');
          const chev = toggleBtn.querySelector('.chev');
          if (chev) {
            chev.style.transform = card.classList.contains('collapsed') ? 'rotate(-90deg)' : 'rotate(0deg)';
          }
          toggleBtn.setAttribute('aria-expanded', String(!card.classList.contains('collapsed')));
          toggleBtn.setAttribute('title', card.classList.contains('collapsed') ? 'Expand' : 'Collapse');
        });

        // Undo button
        const undoBtn = card.querySelector('[data-action="undo"]');
        if (undoBtn) undoBtn.addEventListener('click', function(){
          undoLastChange(card);
        });

        // Take initial snapshot
        snapshotState(card);
      }

      document.querySelectorAll('.flag.card').forEach(initCard);

      // Populate dashboard mock data
      const returns = [
        { client: "Davids, Kerry", period: "Jul 2024 ‚Äì Jun 2025", type: "Individual tax return", lodgement: "-", status: "In review", statusDate: "19 Sep 2025" },
        { client: "Dean, James", period: "Jul 2021 ‚Äì Jun 2022", type: "Individual tax return", lodgement: "-", status: "In review", statusDate: "30 Aug 2025" },
        { client: "Four Leaf Clover Company Ltd", period: "Jul 2023 ‚Äì Jun 2024", type: "Company tax return", lodgement: "-", status: "In review", statusDate: "5 Jun 2025" },
      ];
      const tbody = document.getElementById('returns-tbody');
      if (tbody) {
        tbody.innerHTML = returns.map(function(r, i){
          return '<tr>'+
            '<td>'+r.client+'</td>'+
            '<td>'+r.period+'</td>'+
            '<td>'+r.type+'</td>'+
            '<td><span class="pill">Review</span></td>'+
            '<td><button class="icon-btn" aria-label="Open review checklist" title="Open review checklist" data-open-review data-index="'+i+'">üìù</button></td>'+
            '<td>'+r.lodgement+'</td>'+
            '<td>'+r.status+'</td>'+
            '<td>'+r.statusDate+'</td>'+
          '</tr>'
        }).join('');
      }

      function showReview(clientName) {
        document.getElementById('dashboard-view')?.classList.add('hidden');
        document.getElementById('review-view')?.classList.remove('hidden');
        document.getElementById('section-cards')?.classList.remove('hidden');
        document.getElementById('client-comm-section')?.classList.remove('hidden');
        document.getElementById('actions-section')?.classList.remove('hidden');
        const meta = document.getElementById('meta-line');
        const clientNameEl = document.getElementById('client-name');
        if (clientNameEl) clientNameEl.textContent = clientName;
        // Link the PDF if available
        const pdfLink = document.getElementById('pdf-link');
        if (pdfLink) pdfLink.href = 'assets/docs/Kerry_Davids_FY2025_Individual_tax_return.pdf';
        // Load JSON data and hydrate
        fetch('data/return_2025_kerry_davids.json').then(function(r){ return r.json(); }).then(function(data){
          // Update meta with year and maybe reviewer if present
          const clientNameEl = document.getElementById('client-name');
          if (clientNameEl && data?.clientName) clientNameEl.textContent = data.clientName;
          // Populate client letter intro and notes if present
          if (data?.clientLetter) {
            const issues = document.getElementById('letter-issues');
            // Seed intro notes as a block
            if (issues && Array.isArray(data.clientLetter.notes) && data.clientLetter.notes.length) {
              const key = 'seed-notes';
              const title = 'Notes for your return';
              const icon = '‚ÑπÔ∏è';
              const text = data.clientLetter.intro || '';
              upsertLetterBlock(key, title, icon, text, false);
              data.clientLetter.notes.forEach(function(n){ addNoteToLetter(key, n); });
            }
          }
          // Optional: map item 18 amounts into the Capital losses and CGT cards if available
          const capCard = document.querySelector('[data-key="cap-losses"]');
          if (capCard && Array.isArray(data?.items)) {
            const item18 = data.items.find(function(it){ return it.code === '18'; });
            if (item18?.schedule?.capitalLossesCarriedForward != null) {
              capCard.querySelector('.flag-summary').textContent = '$'+Number(item18.schedule.capitalLossesCarriedForward).toLocaleString()+' carried forward. Ensure correct application this year.';
              const cfLbl = document.getElementById('cf-capital-losses');
              if (cfLbl) cfLbl.textContent = '$'+Number(item18.schedule.capitalLossesCarriedForward).toLocaleString();
            }
          }
          // Map P9 ‚Üí PAYG card
          const paygCard = document.querySelector('[data-key="payg"]');
          if (paygCard && Array.isArray(data?.items)) {
            const p9 = data.items.find(function(it){ return it.code === 'P9'; });
            if (p9?.fields) {
              const ni = p9.fields.netIncome ?? p9.fields.businessNet ?? null;
              const hasWh = p9.fields.hasWithholding ?? false;
              const sbo = p9.fields.smallBusinessOffsetEligible ?? false;
              const parts = [];
              if (ni != null) parts.push('Business net income $'+Number(ni).toLocaleString());
              parts.push(hasWh ? 'with withholding' : 'no withholding');
              const extra = sbo ? ' Eligible for small business income tax offset.' : '';
              let summary = (parts.length ? parts.join(' ‚Äì ') : 'Business income detected') + '. ' + (hasWh ? '' : 'Likely PAYG for FY2026.');
              // include overall taxable income and est. tax if provided
              if (data?.summary?.taxableIncome != null) {
                summary += ' Taxable income: $' + Number(data.summary.taxableIncome).toLocaleString() + '.';
              }
              if (data?.summary?.estimatedTaxPayable != null) {
                summary += ' Est. tax: $' + Number(data.summary.estimatedTaxPayable).toLocaleString() + '.';
              }
              summary += extra;
              const el = paygCard.querySelector('.flag-summary');
              if (el) el.textContent = summary.trim();
            }
          }
          // Map Item 13 ‚Üí Trust card
          const trustCard = document.querySelector('[data-key="trust"]');
          if (trustCard && Array.isArray(data?.items)) {
            const it13 = data.items.find(function(it){ return it.code === '13'; });
            if (it13?.fields) {
              const tname = it13.fields.trustName || 'Trust';
              const amt = it13.fields.distributionAmount ?? null;
              const pct = it13.fields.beneficiarySharePct ?? null;
              const summaryText = 'Distribution in '+(data.clientName || 'client')+"'s return differs from "+tname+ (amt!=null? ' ‚Äì amount $'+Number(amt).toLocaleString():'' ) + (pct!=null? ' ‚Äì beneficiary '+pct+'%':'' ) + '.';
              const sumEl = trustCard.querySelector('.flag-summary');
              if (sumEl) sumEl.textContent = summaryText;
              const docUl = trustCard.querySelector('details summary+ul, details ul');
              const docLabel = trustCard.querySelector('details:nth-of-type(2) ul li');
              if (docLabel) docLabel.textContent = tname+ ' ‚Äì Distribution Statement 2025.pdf';
            }
          }
          // Populate the estimate strip
          const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
          if (data?.summary?.taxableIncome != null) setVal('m-taxable', '$'+Number(data.summary.taxableIncome).toLocaleString());
          if (data?.summary?.estimatedTaxPayable != null) setVal('m-tax', '$'+Number(data.summary.estimatedTaxPayable).toLocaleString());
          const losses = (data?.items||[]).find(it=>it.code==='18')?.schedule?.capitalLossesCarriedForward;
          if (losses != null) setVal('m-losses', '$'+Number(losses).toLocaleString());
          const p9ni = (data?.items||[]).find(it=>it.code==='P9')?.fields?.netIncome;
          if (p9ni != null) setVal('m-p9', '$'+Number(p9ni).toLocaleString());
        }).catch(function(){ /* ignore missing data during prototype */ });
      }

      document.querySelectorAll('[data-open-review]').forEach(function(btn){
        btn.addEventListener('click', function(){
          const idx = this.getAttribute('data-index');
          const selected = returns[Number(idx)]?.client || 'John Smith';
          showReview(selected);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
      });

      const backBtn = document.getElementById('btn-back-dashboard');
      if (backBtn) backBtn.addEventListener('click', function(){
        document.getElementById('dashboard-view')?.classList.remove('hidden');
        document.getElementById('review-view')?.classList.add('hidden');
        document.getElementById('section-cards')?.classList.add('hidden');
        document.getElementById('client-comm-section')?.classList.add('hidden');
        document.getElementById('actions-section')?.classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Footer actions
      const actionsSection = document.querySelector('.section.actions');
      if (actionsSection) {
        const btns = actionsSection.querySelectorAll('button');
        const approveAllBtn = btns[0];
        const editLetterBtn = btns[1];
        const lockBtn = btns[2];

        if (approveAllBtn) approveAllBtn.addEventListener('click', function(){
          document.querySelectorAll('.flag.card [data-action="approve"]').forEach(function(b){
            b.click();
          });
        });

        if (editLetterBtn) editLetterBtn.addEventListener('click', function(){
          const letter = document.querySelector('.letter');
          if (!letter) return;
          const enabled = letter.getAttribute('contenteditable') === 'true';
          letter.setAttribute('contenteditable', enabled ? 'false' : 'true');
          letter.style.outline = enabled ? '' : '2px dashed var(--brand-outline)';
          letter.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        if (lockBtn) lockBtn.addEventListener('click', function(){
          document.querySelectorAll('.flag.card input, .flag.card textarea, .flag.card button').forEach(function(el){
            el.disabled = true;
          });
          const meta = document.querySelector('.header .meta');
          if (meta) meta.innerHTML = meta.innerHTML.replace(/Status:\s*[^&<]*/,'Status: Published');
          alert('Checklist locked and ready to publish');
        });
      }

      // Open larger estimate (image) in modal
      const estBtn = document.getElementById('open-estimate-modal');
      if (estBtn) estBtn.addEventListener('click', function(){
        const html = '\n<div class="modal-overlay" data-return-viewer>\n  <div class="modal-card">\n    <div class="modal-header">\n      <div class="modal-title">Tax Estimate 2025</div>\n      <div class="modal-actions"><button class="btn-mini" data-close-viewer>Close</button></div>\n    </div>\n    <div class="modal-body img-modal-body">\n      <img src="assets/docs/tax_estimate_2025.png" alt="Tax estimate"/>\n    </div>\n  </div>\n</div>';
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        document.body.appendChild(wrap.firstElementChild);
      });

      // Collapse/expand estimate card (use same pattern as other cards)
      const estToggle = document.getElementById('toggle-estimate');
      if (estToggle) estToggle.addEventListener('click', function(){
        const card = document.getElementById('estimate-full');
        if (!card) return;
        const isCollapsed = card.classList.toggle('collapsed');
        const body = card.querySelector('.card-body');
        if (body) body.style.display = isCollapsed ? 'none' : 'block';
        const chev = estToggle.querySelector('.chev');
        if (chev) chev.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        estToggle.setAttribute('aria-expanded', String(!isCollapsed));
        estToggle.setAttribute('title', isCollapsed ? 'Expand' : 'Collapse');
      });
      // Ensure estimate starts collapsed (class is present in markup)
      (function initEstimateCollapsed(){
        const card = document.getElementById('estimate-full');
        if (!card) return;
        const body = card.querySelector('.card-body');
        if (body) body.style.display = 'none';
      })();

      // Open external resources for Item 18 from the Capital losses card
      function openInNewTab(url) {
        try { window.open(url, '_blank', 'noopener'); } catch(e) { location.href = url; }
      }

      function openItem18Viewer() {
        const html = '\n<div class="modal-overlay" data-return-viewer>\n  <div class="modal-card">\n    <div class="modal-header">\n      <div class="modal-title">Item 18 ‚Äì Capital gains</div>\n      <div class="modal-actions">\n        <button class="btn-mini" data-close-viewer>Close</button>\n      </div>\n    </div>\n    <div class="modal-body img-modal-body">\n      <img src="assets/docs/item18_capital_gains_mock.png" alt="Item 18 ‚Äì Capital gains"/>\n    </div>\n  </div>\n</div>';
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        document.body.appendChild(wrap.firstElementChild);
      }

      document.addEventListener('click', function(e){
        const btn = e.target.closest('[data-open], [data-open-schedule], [data-open-schedule-list]');
        if (!btn) return;
        // Map of demo URLs. Replace with real deep links when available.
        const urls = {
          'tax-return': 'assets/docs/Kerry_Davids_FY2025_Individual_tax_return.pdf',
          'item18': 'assets/docs/Kerry_Davids_FY2025_Individual_tax_return.pdf#page=2',
          'capital-losses': 'assets/docs/Capital_Losses_Schedule.pdf',
          'capital-gains-worksheet': 'assets/docs/Capital_Gains_Worksheet.pdf'
        };
        if (btn.hasAttribute('data-open')) {
          const key = btn.getAttribute('data-open');
          const url = urls[key];
          if (key === 'item18') {
            // open image-based simulation viewer
            openItem18Viewer();
          } else if (url) {
            openInNewTab(url);
          }
        } else if (btn.hasAttribute('data-open-schedule')) {
          const key = btn.getAttribute('data-open-schedule');
          const url = urls[key];
          if (url) openInNewTab(url);
        } else if (btn.hasAttribute('data-open-schedule-list')) {
          // Open modal-like preview of related schedules (prototype)
          const listHtml = '\n          <div class="section" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:1000;">\n            <div style="background:#fff;border-radius:10px;max-width:560px;width:100%;box-shadow:0 10px 24px rgba(0,0,0,.2);">\n              <div style="padding:14px 16px;border-bottom:1px solid #edf1f7;font-weight:600;">Related schedules and worksheets</div>\n              <div style="padding:14px 16px;">\n                <ul style="margin:0;padding-left:18px;line-height:1.7;">\n                  <li><a href="'+urls['capital-gains-worksheet']+'" target="_blank" rel="noopener">Capital gains worksheet</a></li>\n                  <li><a href="'+urls['capital-losses']+'" target="_blank" rel="noopener">Capital losses</a></li>\n                </ul>\n              </div>\n              <div style="padding:12px 16px;border-top:1px solid #edf1f7;text-align:right;"><button class="btn-mini" data-close-sched>Close</button></div>\n            </div>\n          </div>';
          const wrapper = document.createElement('div');
          wrapper.innerHTML = listHtml;
          document.body.appendChild(wrapper.firstElementChild);
        }
      });

      document.addEventListener('click', function(e){
        if (e.target && e.target.matches('[data-close-sched]')) {
          const overlay = e.target.closest('div[style*="position:fixed"]');
          if (overlay && overlay.parentElement) overlay.parentElement.removeChild(overlay);
        }
      });

      // Close interactive viewer
      document.addEventListener('click', function(e){
        if (e.target && (e.target.matches('[data-close-viewer]') || e.target.matches('[data-return-viewer]'))) {
          const ov = document.querySelector('.modal-overlay[data-return-viewer]');
          if (ov && ov.parentElement) ov.parentElement.removeChild(ov);
        }
      });

      // Collapse/expand the client letter section
      const letterToggle = document.getElementById('toggle-letter');
      if (letterToggle) letterToggle.addEventListener('click', function(){
        const section = document.getElementById('client-comm-section');
        if (!section) return;
        const isCollapsed = section.classList.toggle('collapsed');
        // Toggle visibility of body
        const body = section.querySelector('.section-body');
        if (body) body.style.display = isCollapsed ? 'none' : 'block';
        // Rotate chevron and aria
        const chev = letterToggle.querySelector('.chev');
        if (chev) chev.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        letterToggle.setAttribute('aria-expanded', String(!isCollapsed));
        letterToggle.setAttribute('title', isCollapsed ? 'Expand' : 'Collapse');
      });

      // Ensure letter section starts collapsed
      (function initLetterCollapsed(){
        const body = document.querySelector('#client-comm-section .section-body');
        if (body) body.style.display = 'none';
      })();
    })();
  </script>
  </div>
</body>
</html>
